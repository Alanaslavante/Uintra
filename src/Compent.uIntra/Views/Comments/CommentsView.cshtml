@using System.Web.Mvc.Ajax
@using System.Web.Mvc.Html
@using uIntra.Comments
@using uIntra.Core.Extentions
@model uIntra.Comments.CommentViewModel

<div id="@Model.CommentViewId" class="js-comment-view" data-id="@Model.Id">
    @Html.Action("Photo", "User", new { user = Model.Creator })
    <div class="comments__list-body">
        <div class="comments__list-holder clearfix">
            <div class="comments__author-about">
                <span class="comments__author-name">@Model.Creator.DisplayedName</span>
                <span class="comments__divider"> - </span>
                <span class="comments__author-date">@(Model.CreatedDate.ToDateFormat())</span>
                <span class="comments__divider"> - </span>
                <span class="comments__author-time">@(Model.CreatedDate.ToTimeFormat())</span>
            </div>

            @if (Model.CanDelete || Model.CanEdit)
            {
                <div class="comments__controls">
                    <ul class="comments__controls-list">
                        <li class="comments__controls-list-item">
                            @if (Model.CanEdit)
                            {
                                <a class="comments__controls-list-link js-comment-editlink">@Html.Localize("CommentsView.Edit.lbl")</a>
                            }
                        </li>
                        <li class="comments__controls-list-item">
                            @if (Model.CanDelete)
                            {
                                @Ajax.ActionLink(Html.Localize("CommentsView.Delete.lbl"), "Delete", "Comments", new { id = Model.Id },
                                    new AjaxOptions { HttpMethod = "Delete", UpdateTargetId = Model.ElementOverviewId, InsertionMode = InsertionMode.Replace, OnComplete = $"new uIntra.methods.CommentOverview('#{Model.ElementOverviewId}');" },
                                    new { @class = "js-comment-delete comments__controls-list-link", data_text = Html.Localize("Common.AreYouSure") })
                            }
                        </li>
                    </ul>
                </div>
            }
            @if (Model.ModifyDate.HasValue)
            {
                <div class="comments__modified">
                    <span class="glyphicon glyphicon-pencil"></span>
                    <div class="comments__modified-info">
                        @Html.Localize("CommentsView.ModifyDate.lbl")
                        <span class="comments__author-date">@(Model.ModifyDate.Value.ToDateFormat())</span>
                        <span class="comments__divider"> - </span>
                        <span class="comments__author-time">@(Model.ModifyDate.Value.ToTimeFormat())</span>
                    </div>
                </div>
            }
            @if (!Model.IsReply)
            {
                <a class="js-comment-showReplyLink comments__reply">@Html.Localize("CommentsView.Reply.lnk")</a>
            }
        </div>
        <div class="feed__item-images">
            @{ Html.RenderAction("RenderGallery", "LightboxGallery", new { mediaIds = Model.MediaIds }); }
        </div>
        <div class="comments__list-text js-comment-description">
            @Html.Raw(Model.Text)
        </div>
        
        @{ Html.RenderAction("CommentLikes", "Likes", new { activityId = Model.ActivityId, commentId = Model.Id }); }

        @if (Model.CanEdit)
        {
            <div class="comments__list-text js-comment-editContainer" style="display: none">
                <span class="js-comment-hideEditLink">Hide</span>
                @Html.Partial("~/App_Plugins/Comments/View/CommentsEditView.cshtml", new CommentEditModel {Id = Model.Id, Text = Model.Text, UpdateElementId = Model.ElementOverviewId})
            </div>
        }

        @if (Model.Replies.Any())
        {
            <ul class="js-comment-view-replies comments__list _inner">
                @foreach (var reply in Model.Replies)
                {
                    <li class="comments__list-item clearfix">@{  Html.RenderPartial("~/App_Plugins/Comments/View/CommentsView.cshtml", reply);}</li>
                }
            </ul>
        }
        @if (!Model.IsReply)
        {
            <div class="js-comment-reply comments__list-replies" style="display: none">
                <span class="js-comment-hideReplyLink comments__hide"><i class="icon-close"></i></span>
                @Html.Partial("~/App_Plugins/Comments/View/CommentsCreateView.cshtml", new CommentCreateModel { ActivityId = Model.ActivityId, ParentId = Model.Id, UpdateElementId = Model.ElementOverviewId, MediaRootId = Model.MediaSettings.MediaRootId})
            </div>
        }
    </div>
</div>